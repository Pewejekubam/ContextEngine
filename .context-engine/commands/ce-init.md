
# Context Engine Initialization

**You are Claude, executing an autonomous initialization workflow.**

This prompt orchestrates Context Engine initialization using deterministic tooling and your reasoning capabilities. Execute all steps without user interaction.

<!-- Generated by template_copy_generator from build/templates/install-template-environment-init.md -->
<!-- Implements constraints INIT-001 through INIT-205 via ce-init.sh CLI tool -->

---

## Step 1: Detect Installation State

```bash
bash .context-engine/commands/ce-init.sh --detect-state
```

**Interpret output**:
- `FRESH_INSTALL` → Continue to Step 2a (Fresh Install Workflow)
- `UPGRADE` → Skip to Step 2b (Upgrade Workflow)

---

## Step 2a: Fresh Install Workflow

### 2a.1: Discover Project Structure

```bash
bash .context-engine/commands/ce-init.sh --discover
```

**Analyze the JSON output**:
- Review `readme_preview` for project purpose and context
- Examine `directories` for logical domain separation
- Check `file_types` for primary technologies
- Use `heuristics` to understand project maturity

### 2a.2: Generate Vocabulary (USE YOUR REASONING)

Based on discovery output, create a vocabulary file that captures the project's domain taxonomy.

**Reasoning process**:

1. **Identify 6-12 domains** using evidence threshold:
   - **Mandatory**: In project title/description, top-level dirs with 10+ files
   - **High**: README Architecture sections, dirs with 5-9 files, dedicated test dirs
   - **Medium**: Import frequency (5+ imports), file naming patterns (3+ files with prefix)
   - **Low**: Single-file evidence, nested subdirs (depth 2+)

2. **Validate domain names**:
   - **Forbidden names**: build, dist, target, out, bin, lib, utils, common, shared, misc, helpers, core, test, tests, node_modules, venv
   - **Format**: lowercase, alphanumeric, hyphens/underscores, 2-20 chars
   - **Synonyms**: Merge (db vs database → db, auth vs authentication → auth, user vs users → user)

3. **Assess confidence**:
   - **HIGH** (auto-commit): 6-12 domains, 2+ sources each, no forbidden, no conflicts
   - **MEDIUM** (review needed): 4-5 or 13-15 domains, weak evidence, potential conflicts
   - **LOW** (report failure): <4 or >15 domains, mostly generic names, insufficient evidence

4. **Generate vocabulary structure**:
   - Domain names: descriptive kebab-case (e.g., "data-transformation" not "transform")
   - Descriptions: Brief semantic description (5-50 words) explaining purpose, scope, key concepts
   - Aliases: Common abbreviations and synonyms for each domain
   - tier_2_tags: **MUST be empty arrays** for organic growth via optimization workflow

   **CRITICAL**: tier_2_tags must be EXACTLY empty arrays: `[]`

   WHY: tier_2_tags will be discovered from actual rule content during optimization.
   They represent specific implementation concepts, NOT domain names.

   **WRONG**: `tier_2_tags: qbd: [parser, transformer, qbd]` (these are tier-1 domain names!)
   **RIGHT**: `tier_2_tags: qbd: []` (will later become ["iif-tokenization", "entity-mapping", "sales-tax-codes"])

   Even if it seems helpful to seed with domain names, DO NOT populate tier_2_tags during initialization.
   The optimization workflow will propose conceptual tags like "test-driven-development" not domain names like "system".

**Write the vocabulary file**:

Create file at: `.context-engine/config/tag-vocabulary.yaml`

```yaml
# Auto-generated by Claude during ce-init
# Project: [project name from README]
# Generated: [ISO 8601 timestamp]
# Domains: [N] identified with [HIGH/MEDIUM/LOW] confidence

schema_version: "3.0.0"

tier_1_domains:
  domain-name:
    description: "What this domain covers - purpose, scope, key concepts"
    aliases: ["alias1", "alias2"]

tier_2_tags:
  domain-name: []  # Empty for organic growth

vocabulary_mappings:
  raw-word: canonical-tag

synonyms: {}

forbidden:
  stopwords:
    - the
    - and
    - for
    - that
    - with
    - this
  patterns: []
  tags:
    - todo
    - fixme
    - hack
    - temp
    - wip
```

### 2a.3: Validate Vocabulary

```bash
bash .context-engine/commands/ce-init.sh --validate-vocab
```

**Check JSON output**:
- If `valid: true` → Continue to Step 2a.4
- If `valid: false` → Fix errors based on `errors` array, rewrite file, retry validation

### 2a.4: Substitute Domain List into Templates

Inject the domain list from vocabulary into slash command templates:

```bash
bash .context-engine/commands/ce-init.sh runtime-template-chatlog-capture.md --substitute-domains
```

**Verify JSON output**:
- If `success: true` → Template processed, output written to commands/
- If `success: false` → Check error message, fix vocabulary or template issue

**Note**: Run this for each template that requires domain substitution. The specific templates are determined by CH1 module specs.

### 2a.5: Run Setup

```bash
bash .context-engine/commands/ce-init.sh --setup
```

**Verify JSON output**:
- If `success: true` → Initialization complete (also creates .claude/commands/ symlinks)
- If `success: false` → Report error and stop

---

## Step 2b: Upgrade Workflow

Run setup directly (vocabulary and database are preserved):

```bash
bash .context-engine/commands/ce-init.sh --setup
```

**Verify JSON output**:
- If `success: true` → Upgrade complete
- If `success: false` → Report error and stop

---

## Completion

Report results to user:

**Fresh Install**:
```
✓ Context Engine initialized successfully
  - State: FRESH_INSTALL
  - Vocabulary: Generated with [N] domains
  - Database: Created
  - Slash commands: Symlinked to .claude/commands/
  - Next: Use /ce-capture to capture chatlogs
```

**Upgrade**:
```
✓ Context Engine upgraded successfully
  - State: UPGRADE
  - Vocabulary: Preserved
  - Database: Preserved
  - Slash commands: Symlinks verified
  - Next: Continue using existing workflows
```

---

## Error Handling

- If any bash command fails with non-zero exit code, stop and report the error
- If vocabulary validation fails, fix the issues and retry
- If setup fails, report the specific error from JSON output
- Do not proceed to next step if current step fails

---

## Technical Details

**Script Location**: `.context-engine/commands/ce-init.sh`
**Prompt Location**: `.context-engine/commands/ce-init.md`
**Implements**: INIT-001 through INIT-205 (44 constraints total)
**CLI Modes**: `--detect-state`, `--discover`, `--validate-vocab`, `--substitute-domains`, `--setup`, `--version`
**Output Format**: JSON (machine-parseable) except `--detect-state` (single word)
**Orchestrator**: This prompt (ce-init.md)
**Executor**: ce-init.sh (deterministic tooling)

For implementation details, see: `build/modules/install-script-environment-init.yaml`
