# Extract Chatlogs to Database

> Context Engine ETL: Transform captured chatlogs into database rules

<!-- Generated by template_copy_generator from build/modules/runtime-command-etl-extract.yaml
     Module: runtime-command-etl-extract v1.3.1
     Implements: EXT-CMD-001 through EXT-CMD-011
-->

## Overview

Extract rules from captured chatlogs and insert them into the Context Engine database.

**What this does:**
- Reads all chatlog YAML files from `data/chatlogs/`
- Transforms rules (ADRs, constraints, invariants) into database rows
- Assigns empty tags + `needs_tags` state for downstream optimization
- Reports extraction statistics

**When to use:**
- After capturing session knowledge with `/ce-capture`
- Before running tag optimization
- As first step in CI/CD pipeline

---

## Run Extraction

```bash
# Find .context-engine directory and run extraction (EXT-CMD-002, EXT-CMD-006)
set -e  # Exit on error (EXT-CMD-010)

# Find project root by detecting deployment.yaml (works from any directory - EXT-CMD-006)
CE_DIR=""
SEARCH_DIR=$(pwd)
while [[ "$SEARCH_DIR" != "/" ]]; do
  if [[ -f "$SEARCH_DIR/.context-engine/config/deployment.yaml" ]]; then
    CE_DIR="$SEARCH_DIR/.context-engine"
    break
  fi
  SEARCH_DIR=$(dirname "$SEARCH_DIR")
done

# Validation: deployment.yaml must exist (EXT-CMD-007)
if [[ -z "$CE_DIR" ]] || [[ ! -f "$CE_DIR/config/deployment.yaml" ]]; then
  echo "Error: Context Engine not initialized."
  echo "Run /ce-init first to set up .context-engine directory."
  exit 1
fi

# Check if chatlogs directory exists and contains files (EXT-CMD-004)
if [[ ! -d "$CE_DIR/data/chatlogs" ]] || [[ -z "$(ls -A "$CE_DIR/data/chatlogs" 2>/dev/null)" ]]; then
  echo "No chatlogs found. Use /ce-capture to create session chatlogs first."
  exit 0
fi

# Run extraction from .context-engine directory (EXT-CMD-001)
# Must be run from .context-engine directory for correct relative paths (v1.3.1 CRITICAL FIX)
(cd "$CE_DIR" && python3 scripts/extract.py 2>&1) > /tmp/extract_output.txt 2>&1

# Capture exit code
EXTRACT_CODE=$?

# Report results (EXT-CMD-003, EXT-CMD-008)
if [[ $EXTRACT_CODE -eq 0 ]]; then
  cat /tmp/extract_output.txt
  echo ""
  echo "✓ Extraction completed successfully"

  # Provide next steps guidance (EXT-CMD-005)
  echo ""
  echo "Next steps:"
  echo "  • Run /ce-optimize-tags to add tags to untagged rules"
  echo "  • Run 'make database-status' to see extraction statistics"
  echo "  • Review rules in database with SQLite queries"
else
  cat /tmp/extract_output.txt
  echo ""
  echo "✗ Extraction failed (exit code: $EXTRACT_CODE)"
  echo ""
  echo "Troubleshooting:"

  # Common error detection (EXT-CMD-009)
  if grep -q "malformed.*yaml\|YAMLError\|yaml\.error" /tmp/extract_output.txt 2>/dev/null; then
    echo "  • Error: malformed chatlog YAML"
    echo "    Validate with: python3 scripts/validate_chatlog.py data/chatlogs/<filename>.yaml"
  fi

  if grep -q "database is locked\|sqlite3.OperationalError" /tmp/extract_output.txt 2>/dev/null; then
    echo "  • Error: database is locked"
    echo "    Close other processes accessing $CE_DIR/data/rules.db and retry"
  fi

  if grep -q "schema.*version\|schema.*mismatch" /tmp/extract_output.txt 2>/dev/null; then
    echo "  • Error: schema version mismatch"
    echo "    Check docs/UPGRADE.md for migration instructions"
  fi

  exit 1
fi
```

---

## Alternative: Use Make

```bash
make chatlogs-extract
```

Both methods produce identical results. Make provides a deterministic environment and handles directory detection automatically.

---

## Constraint Implementation Summary

This command implements:
- **EXT-CMD-001**: Invokes scripts/extract.py from .context-engine directory
- **EXT-CMD-002**: Detects CONTEXT_ENGINE_HOME from deployment.yaml
- **EXT-CMD-003**: Reports extraction success with rule count
- **EXT-CMD-004**: Handles missing chatlogs gracefully
- **EXT-CMD-005**: Suggests next steps (tag optimization, database review)
- **EXT-CMD-006**: Works from any directory (auto-detection pattern)
- **EXT-CMD-007**: Validates deployment.yaml exists
- **EXT-CMD-008**: Reports extract.py errors to user
- **EXT-CMD-009**: Provides remediation guidance for common errors
- **EXT-CMD-010**: Exit code 0 on success, non-zero on failure
- **EXT-CMD-011**: Uses ce- namespace prefix for host isolation

---

## Troubleshooting

### Error: "malformed chatlog YAML"

Validate the chatlog:
```bash
python3 scripts/validate_chatlog.py data/chatlogs/<filename>.yaml
```

### Error: "database is locked"

Close other processes accessing `rules.db` and retry.

### Error: "Context Engine not initialized"

Run `/ce-init` to initialize Context Engine first.

---

✓ Extraction ready!
